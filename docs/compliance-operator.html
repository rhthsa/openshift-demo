
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Compliance Â· OpenShift Demo</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Red Hat Thailand SA">
        
        
    
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="netobserv.html" />
    
    
    <link rel="prev" href="custom-alert.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Infrastructure
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="infrastructure-authentication-providers.html">
            
                <a href="infrastructure-authentication-providers.html">
            
                    
                    OpenShift Authentication Providers with AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="infrastructure-infra-nodes.html">
            
                <a href="infrastructure-infra-nodes.html">
            
                    
                    OpenShift MachineSet and Infrastructure Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="infrastructure-monitoring-alerts.html">
            
                <a href="infrastructure-monitoring-alerts.html">
            
                    
                    OpenShift Platform Monitoring and Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="infrastructure-cluster-logging.html">
            
                <a href="infrastructure-cluster-logging.html">
            
                    
                    OpenShift Cluster Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="loki.html">
            
                <a href="loki.html">
            
                    
                    Loki
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="infrastructure-networking.html">
            
                <a href="infrastructure-networking.html">
            
                    
                    OpenShift Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="infrastructure-backup-etcd.html">
            
                <a href="infrastructure-backup-etcd.html">
            
                    
                    OpenShift state backup with etcd snapshot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="infrastructure-taint-and-toleration.html">
            
                <a href="infrastructure-taint-and-toleration.html">
            
                    
                    Pod Taint and Toleration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="assign-pod-to-node.html">
            
                <a href="assign-pod-to-node.html">
            
                    
                    Assign pod to node
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="custom-roles.html">
            
                <a href="custom-roles.html">
            
                    
                    Custom Roles and Service Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="custom-alert.html">
            
                <a href="custom-alert.html">
            
                    
                    Custom Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.12" data-path="compliance-operator.html">
            
                <a href="compliance-operator.html">
            
                    
                    Compliance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.13" data-path="netobserv.html">
            
                <a href="netobserv.html">
            
                    
                    Network Observability
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Multi-cluster Management with Advanced Cluster Management (RHACM)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="acm-application-management.html">
            
                <a href="acm-application-management.html">
            
                    
                    Application Manageement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="acm-hibernate.html">
            
                <a href="acm-hibernate.html">
            
                    
                    Cost saving with hibernating OpenShift
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Advanced Cluster Security for Kubernetes
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="acs.html">
            
                <a href="acs.html">
            
                    
                    ACS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Applications
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="build-with-dev-console.html">
            
                <a href="build-with-dev-console.html">
            
                    
                    Developer Console
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="build-with-oc.html">
            
                <a href="build-with-oc.html">
            
                    
                    Application Build & Deployment with oc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="build-with-odo.html">
            
                <a href="build-with-odo.html">
            
                    
                    Application Build & Deployment with odo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="helm.html">
            
                <a href="helm.html">
            
                    
                    Application Deployment with Helm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="imagestreams.html">
            
                <a href="imagestreams.html">
            
                    
                    Image Streams
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="openshift-route.html">
            
                <a href="openshift-route.html">
            
                    
                    OpenShift Route
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="hpa.html">
            
                <a href="hpa.html">
            
                    
                    Horizontal Pod Autoscaler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="health.html">
            
                <a href="health.html">
            
                    
                    Health Check
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="kustomize.html">
            
                <a href="kustomize.html">
            
                    
                    Kustomize
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="application-metrics.html">
            
                <a href="application-metrics.html">
            
                    
                    User Workload Monitoring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="ci-cd-with-jenkins.html">
            
                <a href="ci-cd-with-jenkins.html">
            
                    
                    CI/CD with Jenkins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.12" data-path="ci-cd.html">
            
                <a href="ci-cd.html">
            
                    
                    CI/CD with Azure DevOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.13" data-path="eap-on-ocp.html">
            
                <a href="eap-on-ocp.html">
            
                    
                    EAP on OpenShift
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Additional Features
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="gitops.html">
            
                <a href="gitops.html">
            
                    
                    OpenShift GitOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="openshift-service-mesh.html">
            
                <a href="openshift-service-mesh.html">
            
                    
                    OpenShift Service Mesh
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Compliance</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="openshift-compliance-with-compliance-operator">OpenShift Compliance with Compliance Operator</h1>
<ul>
<li><a href="#openshift-compliance-with-compliance-operator">OpenShift Compliance with Compliance Operator</a><ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#compliance-operator">Compliance Operator</a></li>
<li><a href="#cis-profile">CIS Profile</a></li>
<li><a href="#openscap-report">Openscap Report</a><ul>
<li><a href="#cis">CIS</a></li>
<li><a href="#pci-dss">PCI-DSS</a></li>
<li><a href="#reports">Reports</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>OpenShift 4.6+</li>
<li>Cluster-admin user access</li>
</ul>
<h2 id="compliance-operator">Compliance Operator</h2>
<ul>
<li>Install Compliance Operator from OperatorHub</li>
<li><p><strong>[Optional]</strong> Verify Compliance Operator</p>
<ul>
<li><p>Check compliance profile</p>
<pre><code class="lang-bash">oc get profiles.compliance -n openshift-compliance
</code></pre>
<p>Output example</p>
<pre><code class="lang-bash">NAME                 AGE
ocp4-cis             8m8s
ocp4-cis-node        8m8s
ocp4-e8              8m8s
ocp4-moderate        8m7s
ocp4-moderate-node   8m7s
ocp4-nerc-cip        8m7s
ocp4-nerc-cip-node   8m7s
ocp4-pci-dss         8m7s
ocp4-pci-dss-node    8m7s
rhcos4-e8            8m2s
rhcos4-moderate      8m2s
rhcos4-nerc-cip      8m1s
</code></pre>
</li>
<li><p>Check detail of profile</p>
<pre><code class="lang-bash">oc get -o yaml profiles.compliance ocp4-cis  -n openshift-compliance
</code></pre>
<p>Output example</p>
<pre><code class="lang-yaml">...
rules:
- ocp4-accounts-restrict-service-account-tokens
- ocp4-accounts-unique-service-account
- ocp4-api-server-admission-control-plugin-alwaysadmit
- ocp4-api-server-admission-control-plugin-alwayspullimages
- ocp4-api-server-admission-control-plugin-namespacelifecycle
- ocp4-api-server-admission-control-plugin-noderestriction
...
</code></pre>
</li>
<li><p>Check details of rule</p>
<pre><code class="lang-bash">oc get -o yaml rules.compliance ocp4-accounts-unique-service-account  -n openshift-compliance
</code></pre>
</li>
</ul>
</li>
<li><p>Check for default ScanSetting</p>
<ul>
<li><p>List all ScanSetting</p>
<pre><code class="lang-bash">oc get scansettings -n openshift-compliance
</code></pre>
<p>Result</p>
<pre><code class="lang-bash">NAME                 AGE
default              35m
default-auto-apply   35m
</code></pre>
</li>
<li><p>Check for <em>default</em> ScanSetting</p>
<pre><code class="lang-bash">oc describe scansettings default -n openshift-compliance
</code></pre>
<p>Output example, scheduled at 1AM everyday and apply to both master and worker node and use block storage (RWO) for stored result</p>
<pre><code class="lang-bash">Raw Result Storage:
  Pv Access Modes:
    ReadWriteOnce
  Rotation:  3
  Size:      1Gi
Roles:
  worker
  master
Scan Tolerations:
  Effect:    NoSchedule
  Key:       node-role.kubernetes.io/master
  Operator:  Exists
  Schedule:    0 1 * * *
  Events:      &lt;none&gt;
</code></pre>
<h2 id="cis-profile">CIS Profile</h2>
</li>
</ul>
</li>
<li><p>To start scan, create ScanSettingBinding. Scan will be started immediately after save</p>
<ul>
<li><p>Use Admin Console to create ScanSettingBinding, default is <em>rhcos4-moderate</em> and use default <em>ScanSetting</em></p>
<p><img src="images/compliance-default-scansettingbinding.png" alt=""></p>
</li>
<li><p>Add <em>opc4-cis</em> and <em>ocp4-cis-node</em> profiles for CIS compliance to <a href="manifests/cis-profile.yaml">ScanSettingBinding</a> or add  <em>ocp4-pci-dss</em> and  <em>ocp4-pci-dss-node</em> for PCI-DSS compliance</p>
<pre><code class="lang-yaml">apiVersion: compliance.openshift.io/v1alpha1
profiles:
  - apiGroup: compliance.openshift.io/v1alpha1
    name: ocp4-cis-node
    kind: Profile
  - apiGroup: compliance.openshift.io/v1alpha1
    name: ocp4-cis
    kind: Profile 
settingsRef:
  apiGroup: compliance.openshift.io/v1alpha1
  name: default
  kind: ScanSetting
kind: ScanSettingBinding
metadata:
  name: cis-profile
  namespace: openshift-compliance
</code></pre>
<p>or use CLI</p>
<pre><code class="lang-bash">oc apply -f manifests/cis-profile.yaml
oc apply -f manifests/pci-dss-profile.yaml
oc describe scansettingbinding/cis-profile -n openshift-compliance|grep -A14  &quot;Status:&quot; 
oc describe scansettingbinding/pci-dss-profile -n openshift-compliance|grep -A14  &quot;Status:&quot;
</code></pre>
<p>Check for status</p>
<pre><code class="lang-bash">Status:
  Conditions:
    Last Transition Time:  2022-04-12T08:00:27Z
    Message:               The scan setting binding was successfully processed
    Reason:                Processed
    Status:                True
    Type:                  Ready
  Output Ref:
    API Group:  compliance.openshift.io
    Kind:       ComplianceSuite
    Name:       cis-profile
Events:
  Type    Reason        Age   From                    Message
  ----    ------        ----  ----                    -------
  Normal  SuiteCreated  10s   scansettingbindingctrl  ComplianceSuite openshift-compliance/cis-profile created
</code></pre>
</li>
<li><p>Check ComplianceScan tab</p>
<p><img src="images/compliance-progress-compliancescan.png" alt=""></p>
</li>
<li><p>or use CLI</p>
<pre><code class="lang-bash">watch -d oc get compliancescan -n openshift-compliance
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                       PHASE       RESULT
ocp4-cis                   RUNNING     NOT-AVAILABLE
ocp4-cis-node-master       RUNNING     NOT-AVAILABLE
ocp4-cis-node-worker       RUNNING     NOT-AVAILABLE
ocp4-pci-dss               RUNNING     NOT-AVAILABLE
ocp4-pci-dss-node-master   LAUNCHING   NOT-AVAILABLE
ocp4-pci-dss-node-worker   LAUNCHING   NOT-AVAILABLE
</code></pre>
<p>When compliance scan is completed</p>
<pre><code class="lang-bash">NAME                       PHASE   RESULT
ocp4-cis                   DONE    NON-COMPLIANT
ocp4-cis-node-master       DONE    NON-COMPLIANT
ocp4-cis-node-worker       DONE    NON-COMPLIANT
ocp4-pci-dss               DONE    NON-COMPLIANT
ocp4-pci-dss-node-master   DONE    NON-COMPLIANT
ocp4-pci-dss-node-worker   DONE    NON-COMPLIANT
</code></pre>
</li>
</ul>
</li>
<li><p>Check result</p>
<ul>
<li><p>Count for FAIL </p>
<pre><code class="lang-bash">oc get compliancecheckresult -n openshift-compliance | grep FAIL
NUM_OF_CIS_FAILED_BEFORE_REMIDIATE=$(oc get compliancecheckresult -n openshift-compliance | grep FAIL|grep cis|wc -l)
NUM_OF_PCI_DSS_FAILED_BEFORE_REMIDIATE=$(oc get compliancecheckresult -n openshift-compliance | grep FAIL|grep pci-dss|wc -l)
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">ocp4-pci-dss-node-worker-kubelet-eviction-thresholds-set-soft-imagefs-available    FAIL     medium
ocp4-pci-dss-node-worker-kubelet-eviction-thresholds-set-soft-imagefs-inodesfree   FAIL     medium
ocp4-pci-dss-node-worker-kubelet-eviction-thresholds-set-soft-memory-available     FAIL     medium
ocp4-pci-dss-node-worker-kubelet-eviction-thresholds-set-soft-nodefs-available     FAIL     medium
ocp4-pci-dss-node-worker-kubelet-eviction-thresholds-set-soft-nodefs-inodesfree    FAIL     medium
</code></pre>
</li>
<li><p>Check for result description for <em>ocp4-cis-api-server-encryption-provider-config</em></p>
<pre><code class="lang-bash">oc describe compliancecheckresult/ocp4-cis-api-server-encryption-provider-config -n openshift-compliance
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">...
Description:  Configure the Encryption Provider
etcd is a highly available key-value store used by OpenShift deployments
for persistent storage of all REST API objects. These objects are
sensitive in nature and should be encrypted at rest to avoid any
disclosures.
Id:            xccdf_org.ssgproject.content_rule_api_server_encryption_provider_config
Instructions:  Run the following command:
$ oc get apiserver cluster -ojson | jq -r &apos;.spec.encryption.type&apos;
The output should return aescdc as the encryption type.
...
Severity:                  medium
Status:                    FAILED
Events:                    &lt;none&gt;
</code></pre>
</li>
</ul>
</li>
<li><p>Fix failed policies with <em>ComplianceRemediation</em></p>
<ul>
<li><p>List <em>ComplianceRemediation</em></p>
<pre><code class="lang-bash">oc get ComplianceRemediation -n openshift-compliance
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                                                                                 STATE
ocp4-cis-api-server-encryption-provider-cipher                                       NotApplied
ocp4-cis-api-server-encryption-provider-config                                       NotApplied
ocp4-cis-node-master-kubelet-configure-event-creation                                NotApplied
ocp4-cis-node-master-kubelet-configure-tls-cipher-suites                             NotApplied
ocp4-cis-node-master-kubelet-enable-iptables-util-chains                             NotApplied
ocp4-cis-node-master-kubelet-enable-protect-kernel-defaults                          NotApplied
ocp4-cis-node-master-kubelet-enable-protect-kernel-sysctl                            NotApplied
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-imagefs-available          NotApplied
ocp4-cis-node-master-kubelet-eviction-thresholds-set-hard-imagefs-available-1        NotApplied
...
</code></pre>
</li>
<li><p>Fix failed <em>ocp4-cis-api-server-encryption-provider-config</em> and <em>ocp4-cis-api-server-encryption-provider-cipher</em> policy with <em>ComplianceRemidiation</em></p>
<pre><code class="lang-bash">oc patch -n openshift-compliance complianceremediation \
ocp4-cis-api-server-encryption-provider-config -p &apos;{&quot;spec&quot;:{&quot;apply&quot;:true}}&apos; --type=&apos;merge&apos;
oc patch -n openshift-compliance complianceremediation \
ocp4-cis-api-server-encryption-provider-cipher -p &apos;{&quot;spec&quot;:{&quot;apply&quot;:true}}&apos; --type=&apos;merge&apos;
</code></pre>
<p>Check result</p>
<pre><code class="lang-bash">oc get ComplianceRemediation/ocp4-cis-api-server-encryption-provider-config -n openshift-compliance
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                                             STATE
ocp4-cis-api-server-encryption-provider-config   Applied
</code></pre>
</li>
</ul>
</li>
<li><p>Re-run scan</p>
<ul>
<li><p>Annotate <em>ComplianceScans</em> to rescan or use <a href="bin/rerun-compliance-scan.sh">script</a></p>
<pre><code class="lang-bash">for scan in $(oc get compliancescans -n openshift-compliance -o custom-columns=NAME:.metadata.name --no-headers)
do
oc annotate compliancescans $scan compliance.openshift.io/rescan= -n openshift-compliance
done
watch -d oc get compliancescans -n openshift-compliance
</code></pre>
<p>Result</p>
<pre><code class="lang-bash">NAME                       PHASE         RESULT
ocp4-cis                   DONE          NON-COMPLIANT
ocp4-cis-node-master       DONE          NON-COMPLIANT
ocp4-cis-node-worker       DONE          NON-COMPLIANT
ocp4-pci-dss               DONE          NON-COMPLIANT
ocp4-pci-dss-node-master   AGGREGATING   NOT-AVAILABLE
ocp4-pci-dss-node-worker   AGGREGATING   NOT-AVAILABLE
</code></pre>
</li>
<li><p>Recheck policy <em>ocp4-cis-api-server-encryption-provider-config</em></p>
<pre><code class="lang-bash">oc describe compliancecheckresult/ocp4-cis-api-server-encryption-provider-config -n openshift-compliance | grep -A3 Severity
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">Severity:                  medium
Status:                    PASS
Events:                    &lt;none&gt;
</code></pre>
</li>
</ul>
</li>
<li><p>Change <em>ScanSettingBinding</em> cis-and-moderate-profile to use ScanSetting <em>default-auto-apply</em></p>
<pre><code class="lang-bash">oc patch -n openshift-compliance ScanSettingBinding cis-profile -p &apos;{&quot;settingsRef&quot;:{&quot;name&quot;:&quot;default-auto-apply&quot;}}&apos; --type=&apos;merge&apos;
oc patch -n openshift-compliance ScanSettingBinding pci-dss-profile -p &apos;{&quot;settingsRef&quot;:{&quot;name&quot;:&quot;default-auto-apply&quot;}}&apos; --type=&apos;merge&apos;
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">scansettingbinding.compliance.openshift.io/cis-profile patched
scansettingbinding.compliance.openshift.io/pci-dss-profile patched
</code></pre>
</li>
</ul>
<p>  Compare number of failed compliance before and after remidiate</p>
<pre><code class="lang-bash">  NUM_OF_CIS_FAILED_AFTER_REMIDIATE=$(oc get compliancecheckresult -n openshift-compliance | grep FAIL|grep cis|wc -l)
  NUM_OF_PCI_DSS_FAILED_AFTER_REMIDIATE=$(oc get compliancecheckresult -n openshift-compliance | grep FAIL|grep pci-dss|wc -l)
  echo &quot;Number of failed CIS compliance reduce from $NUM_OF_CIS_FAILED_BEFORE_REMIDIATE to $NUM_OF_CIS_FAILED_AFTER_REMIDIATE&quot;
</code></pre>
<h2 id="openscap-report">Openscap Report</h2>
<p> Generate HTML reports for latest scan results by using oscap tools. Container image with oscap tools already build with this <a href="manifests/Dockerfile.oscap">Dockerfile</a></p>
<h3 id="cis">CIS</h3>
<pre><code>- Create [pods](manifests/cis-report.yaml) to mount to CIS reports PVC

  ```bash
  oc create -f manifests/cis-report.yaml -n openshift-compliance
  watch oc get pods -l app=report-generator -n openshift-compliance
  ```

  Output

  ```bash
  NAME                READY   STATUS    RESTARTS   AGE
  cis-master-report   1/1     Running   0          54s
  cis-report          1/1     Running   0          55s
  cis-worker-report   1/1     Running   0          55s
  ```

  ![](images/compliance-cis-report-generator-pods.png)

- Generate CIS reports with *oscap*

  ```bash
  REPORTS_DIR=compliance-operator-reports
  mkdir -p $REPORTS_DIR
  reports=(cis-report cis-worker-report cis-master-report)
  for report in ${reports[@]}
  do
    DIR=$(oc exec -n openshift-compliance $report -- ls -1t /reports|grep -v &quot;lost+found&quot;|head -n 1)

    for file in $(oc exec -n openshift-compliance $report -- ls -1t /reports/$DIR)
    do
      echo &quot;Generate report for $report from $file&quot;
      oc exec -n openshift-compliance $report -- oscap xccdf generate report /reports/$DIR/$file &gt; $REPORTS_DIR/$report-$file.html
    done
  done 
  oc delete pods -l app=report-generator -n openshift-compliance
  ```

  Sample output

  ```bash
    Generate report for cis-report from ocp4-cis-api-checks-pod.xml.bzip2
    Generate report for cis-worker-report from openscap-pod-f73cef8b1e6a98fa8233b84163f62300c60df10e.xml.bzip2
    Generate report for cis-worker-report from openscap-pod-ac5e7838c12d9bea905d474069522b5b502ad724.xml.bzip2
    Generate report for cis-master-report from openscap-pod-47877a9e79536f85e552662526e0cd247278bf47.xml.bzip2
    Generate report for cis-master-report from openscap-pod-3c5d5e72bf73ebbdbc4ff5cf27f6c3443534e9d6.xml.bzip2
    Generate report for cis-master-report from openscap-pod-cd506d793bc03ad62909572b95df1d2d94d13a3e.xml.bzip2
  ```
</code></pre><h3 id="pci-dss">PCI-DSS</h3>
<pre><code>- Create [pods](manifests/cis-report.yaml) to mount to PCI-DSS reports PVC

  ```bash
  oc create -f manifests/pci-dss-report.yaml -n openshift-compliance
  watch oc get pods -l app=report-generator -n openshift-compliance
  ```

  Output

  ```bash
  NAME                    READY   STATUS    RESTARTS   AGE
  pci-dss-master-report   1/1     Running   0          11s
  pci-dss-report          1/1     Running   0          12s
  pci-dss-worker-report   1/1     Running   0          12
  ```


- Generate PCI-DSS reports with *oscap*

  ```bash
  REPORTS_DIR=compliance-operator-reports
  mkdir -p $REPORTS_DIR
  reports=(pci-dss-report pci-dss-worker-report pci-dss-master-report)
  for report in ${reports[@]}
  do
    DIR=$(oc exec -n openshift-compliance $report -- ls -1t /reports|grep -v &quot;lost+found&quot;|head -n 1)

    for file in $(oc exec -n openshift-compliance $report -- ls -1t /reports/$DIR)
    do
      echo &quot;Generate report for $report from $file&quot;
      oc exec -n openshift-compliance $report -- oscap xccdf generate report /reports/$DIR/$file &gt; $REPORTS_DIR/$report-$file.html
    done
  done 
  oc delete pods -l app=report-generator -n openshift-compliance
  ```

  Sample output

  ```bash
    Generate report for cis-report from ocp4-cis-api-checks-pod.xml.bzip2
    Generate report for cis-worker-report from openscap-pod-f73cef8b1e6a98fa8233b84163f62300c60df10e.xml.bzip2
    Generate report for cis-worker-report from openscap-pod-ac5e7838c12d9bea905d474069522b5b502ad724.xml.bzip2
    Generate report for cis-master-report from openscap-pod-47877a9e79536f85e552662526e0cd247278bf47.xml.bzip2
    Generate report for cis-master-report from openscap-pod-3c5d5e72bf73ebbdbc4ff5cf27f6c3443534e9d6.xml.bzip2
    Generate report for cis-master-report from openscap-pod-cd506d793bc03ad62909572b95df1d2d94d13a3e.xml.bzip2
  ```
</code></pre><h3 id="reports">Reports</h3>
<p>Sample reports of OpenShift clusters with auto-remidiation  </p>
<ul>
<li><a href="compliance-operator-reports/fix-with-auto-remidiation/cis-report-ocp4-cis-api-checks.pdf">CIS</a> </li>
<li><a href="compliance-operator-reports/pci-dss/pci-dss-report-ocp4-pci-dss-api-checks-pod.pdf">PCI-DSS</a></li>
<li>HTML version <a href="compliance-operator-reports">here</a> </li>
</ul>
<p>Sample <a href="compliance-operator-reports/fix-kubelet">reports</a> of OpenShift clusters with secure <a href="manifests/cis-secure-kubelet.yaml">kubelet config</a> for machine config master and worker.</p>
<ul>
<li><p>kubelet config</p>
<pre><code class="lang-yaml">    kubeletConfig:
      eventRecordQPS: 5
      tlsCipherSuites:
      - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
      - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
</code></pre>
</li>
<li><p>Secure /etc/sysctl.d/90-kubelet.conf for </p>
<pre><code class="lang-properties">vm.overcommit_memory=1
vm.panic_on_oom=0
kernel.panic=10
kernel.panic_on_oops=1
kernel.keys.root_maxkeys=1000000
kernel.keys.root_maxbytes=25000000
</code></pre>
</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="custom-alert.html" class="navigation navigation-prev " aria-label="Previous page: Custom Alert">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="netobserv.html" class="navigation navigation-next " aria-label="Next page: Network Observability">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Compliance","level":"1.2.12","depth":2,"next":{"title":"Network Observability","level":"1.2.13","depth":2,"path":"netobserv.md","ref":"netobserv.md","articles":[]},"previous":{"title":"Custom Alert","level":"1.2.11","depth":2,"path":"custom-alert.md","ref":"custom-alert.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","-highlight","-livereload","search-plus","copy-code-button","mermaid-gb3"],"root":"./","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mermaid-newface":{"theme":"neutral"},"search-plus":{},"copy-code-button":{},"mermaid-gb3":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Red Hat Thailand SA","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"OpenShift Demo","gitbook":"3.2.3"},"file":{"path":"compliance-operator.md","mtime":"2023-11-08T09:46:42.987Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-11-08T09:47:16.647Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

