{"source":2,"revision":8,"description":null,"createdBy":{"displayName":"chatchai kongmanee","url":"https://spsprodea1.vssps.visualstudio.com/A845d3643-310d-40e2-b090-cd318257b9c9/_apis/Identities/17eecb97-0b7d-6529-9bbb-a4a61a0f1147","_links":{"avatar":{"href":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"id":"17eecb97-0b7d-6529-9bbb-a4a61a0f1147","uniqueName":"chatapazar@gmail.com","imageUrl":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3","descriptor":"msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"},"createdOn":"2021-01-07T08:36:09.877Z","modifiedBy":{"displayName":"chatchai kongmanee","url":"https://spsprodea1.vssps.visualstudio.com/A845d3643-310d-40e2-b090-cd318257b9c9/_apis/Identities/17eecb97-0b7d-6529-9bbb-a4a61a0f1147","_links":{"avatar":{"href":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"id":"17eecb97-0b7d-6529-9bbb-a4a61a0f1147","uniqueName":"chatapazar@gmail.com","imageUrl":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3","descriptor":"msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"},"modifiedOn":"2021-01-07T09:55:33.770Z","isDeleted":false,"lastRelease":{"id":78,"name":"Release-12","artifacts":[],"_links":{},"description":"","releaseDefinition":{"id":3,"projectReference":null,"_links":{}},"createdOn":"2021-01-12T09:21:04.270Z","createdBy":{"displayName":"chatchai kongmanee","url":"https://spsprodea1.vssps.visualstudio.com/A845d3643-310d-40e2-b090-cd318257b9c9/_apis/Identities/17eecb97-0b7d-6529-9bbb-a4a61a0f1147","_links":{"avatar":{"href":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"id":"17eecb97-0b7d-6529-9bbb-a4a61a0f1147","uniqueName":"chatapazar@gmail.com","imageUrl":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3","descriptor":"msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"variables":{"activeApp":{"value":"front-blue"},"destApp":{"value":"front-blue"},"ocpcluster":{"value":"apps.cluster-852b.852b.example.opentlc.com"},"replicas":{"value":"1"}},"variableGroups":[],"environments":[{"id":6,"name":"switch to new version","rank":1,"owner":{"displayName":"chatchai kongmanee","url":"https://spsprodea1.vssps.visualstudio.com/A845d3643-310d-40e2-b090-cd318257b9c9/_apis/Identities/17eecb97-0b7d-6529-9bbb-a4a61a0f1147","_links":{"avatar":{"href":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"id":"17eecb97-0b7d-6529-9bbb-a4a61a0f1147","uniqueName":"chatapazar@gmail.com","imageUrl":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3","descriptor":"msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":17}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":20},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":21}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-18.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":27,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"44babac3-ab28-4f68-b843-bf2c295a4a2d","version":"2.*","name":"oc-setup ","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"OpenShift Connection Service","openshiftService":"eb11c478-f442-4003-aa2a-bd581097dd92","configurationType":"file","configurationPath":"","inlineConfig":"","version":"4.4","proxy":""}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"prepare variable","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n\nOUTPUT=$(oc get route/front --no-headers -n bot | awk '{print $3}')\n\necho \"activeApp is ${OUTPUT}\"\n\nif [[ \"${OUTPUT}\" == \"front-blue\" ]]; then\necho 'set destApp=front-green'\necho '##vso[task.setvariable variable=destApp]front-green'\necho '##vso[task.setvariable variable=activeApp]front-blue'\nREPLICASNUMBER=$(oc get dc/front-blue --no-headers -n bot | awk '{print $3}')\necho \"##vso[task.setvariable variable=replicas]$REPLICASNUMBER\"\nelse\necho 'set destApp=front-blue'\necho '##vso[task.setvariable variable=destApp]front-blue'\necho '##vso[task.setvariable variable=activeApp]front-green'\nREPLICASNUMBER=$(oc get dc/front-green --no-headers -n bot | awk '{print $3}')\necho \"##vso[task.setvariable variable=replicas]$REPLICASNUMBER\"\nfi\n\noc set triggers dc/front-blue --manual -n bot\noc set triggers dc/front-green --manual -n bot","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"blue to green","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n \necho \"activeApp is $(activeApp)\"\necho \"destApp is $(destApp)\"\necho \"replicas is $(replicas)\"\n\nif [[ \"$(activeApp)\" == \"front-blue\" ]]; then\n\necho \"work blue to green\"\noc tag bot/demofront:$(Release.Artifacts.front.BuildNumber) bot/front-green:latest\noc label --overwrite dc/front-green build.version=$(Release.Artifacts.front.BuildNumber) -n bot\noc label --overwrite dc/front-green release.version=$(Release.ReleaseName) -n bot\noc patch dc front-green -p \"{\\\"spec\\\":{\\\"replicas\\\":$(replicas)}}\" -n bot\noc rollout latest dc/front-green -n bot\n\nrc_version=$(oc get dc front-green -n bot -o jsonpath='{.status.latestVersion}{\"\\n\"}')\necho \"green rc_version is ${rc_version}\"\n\nready=$(oc get rc \"front-green-${rc_version}\" -n bot -o jsonpath='{.status.readyReplicas}{\"\\n\"}')\necho \"green rc_version ready is ${ready}\"\n\nwhile [[ ${ready}  !=  $(replicas) ]]\ndo\n  sleep 5\n  ready=$(oc get rc \"front-green-${rc_version}\" -n bot -o jsonpath='{.status.readyReplicas}{\"\\n\"}')\n  echo \"green rc_version ready is ${ready}\"\ndone\n\noc patch route front -p '{\"spec\":{\"to\":{\"name\":\"front-green\"}}}' -n bot\n\nfi\n\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"green to blue","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n \necho \"activeApp is $(activeApp)\"\necho \"destApp is $(destApp)\"\necho \"replicas is $(replicas)\"\n\nif [[ \"$(activeApp)\" == \"front-green\" ]]; then\n\necho \"work green to blue\"\noc tag bot/demofront:$(Release.Artifacts.front.BuildNumber) bot/front-blue:latest\noc label --overwrite dc/front-blue build.version=$(Release.Artifacts.front.BuildNumber) -n bot\noc label --overwrite dc/front-blue release.version=$(Release.ReleaseName) -n bot\noc patch dc front-blue -p \"{\\\"spec\\\":{\\\"replicas\\\":$(replicas)}}\" -n bot\noc rollout latest dc/front-blue -n bot\n\nrc_version=$(oc get dc front-blue -n bot -o jsonpath='{.status.latestVersion}{\"\\n\"}')\necho \"blue rc_version is ${rc_version}\"\n\nready=$(oc get rc \"front-blue-${rc_version}\" -n bot -o jsonpath='{.status.readyReplicas}{\"\\n\"}')\necho \"blue rc_version ready is ${ready}\"\n\nwhile [[ ${ready}  !=  $(replicas) ]]\ndo\n  sleep 5\n  ready=$(oc get rc \"front-blue-${rc_version}\" -n bot -o jsonpath='{.status.readyReplicas}{\"\\n\"}')\n  echo \"blue rc_version ready is ${ready}\"\ndone\n\noc patch route front -p '{\"spec\":{\"to\":{\"name\":\"front-blue\"}}}' -n bot\n\nfi\n\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":78,"url":"https://vsrm.dev.azure.com/chatapazar0583/a9304c9c-ddfc-4a30-90ca-6770b0340d97/_apis/Release/releases/78","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/chatapazar0583/_apis/public/Release/badge/a9304c9c-ddfc-4a30-90ca-6770b0340d97/3/6"},{"id":7,"name":"scale down previous version","rank":2,"owner":{"displayName":"chatchai kongmanee","url":"https://spsprodea1.vssps.visualstudio.com/A845d3643-310d-40e2-b090-cd318257b9c9/_apis/Identities/17eecb97-0b7d-6529-9bbb-a4a61a0f1147","_links":{"avatar":{"href":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"}},"id":"17eecb97-0b7d-6529-9bbb-a4a61a0f1147","uniqueName":"chatapazar@gmail.com","imageUrl":"https://dev.azure.com/chatapazar0583/_apis/GraphProfile/MemberAvatars/msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3","descriptor":"msa.MTdlZWNiOTctMGI3ZC03NTI5LTliYmItYTRhNjFhMGYxMTQ3"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":18}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":19},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":22}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-18.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":27,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"44babac3-ab28-4f68-b843-bf2c295a4a2d","version":"2.*","name":"oc-setup ","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"OpenShift Connection Service","openshiftService":"eb11c478-f442-4003-aa2a-bd581097dd92","configurationType":"file","configurationPath":"","inlineConfig":"","version":"4.4","proxy":""}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Bash Script","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n \nOUTPUT=$(oc get route/front --no-headers -n bot | awk '{print $3}')\n\necho \"current is ${OUTPUT}\"\n\nif [[ \"${OUTPUT}\" == \"front-blue\" ]]; then\n\noc patch dc front-green -p \"{\\\"spec\\\":{\\\"replicas\\\":0}}\" -n bot\n\nelse\n\noc patch dc front-blue -p \"{\\\"spec\\\":{\\\"replicas\\\":0}}\" -n bot\n\n\nfi\n\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"switch to new version","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":78,"url":"https://vsrm.dev.azure.com/chatapazar0583/a9304c9c-ddfc-4a30-90ca-6770b0340d97/_apis/Release/releases/78","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/chatapazar0583/_apis/public/Release/badge/a9304c9c-ddfc-4a30-90ca-6770b0340d97/3/7"}],"artifacts":[{"sourceId":"a9304c9c-ddfc-4a30-90ca-6770b0340d97:8","type":"Build","alias":"front","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://dev.azure.com/chatapazar0583/_permalink/_build/index?collectionId=f0bfb034-9a12-42ff-b323-f74f68c7d3e4&projectId=a9304c9c-ddfc-4a30-90ca-6770b0340d97&definitionId=8","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"8","name":"DCS BOT Pipeline"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"a9304c9c-ddfc-4a30-90ca-6770b0340d97","name":"BOTDemoApplication.Front"},"repository":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseClone"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":3,"name":"blue-green","path":"\\DCS","projectReference":null,"url":"https://vsrm.dev.azure.com/chatapazar0583/a9304c9c-ddfc-4a30-90ca-6770b0340d97/_apis/Release/definitions/3","_links":{"self":{"href":"https://vsrm.dev.azure.com/chatapazar0583/a9304c9c-ddfc-4a30-90ca-6770b0340d97/_apis/Release/definitions/3"},"web":{"href":"https://dev.azure.com/chatapazar0583/a9304c9c-ddfc-4a30-90ca-6770b0340d97/_release?definitionId=3"}}}